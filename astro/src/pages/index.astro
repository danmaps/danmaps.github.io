---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { buildTagLink, type TagLink } from '../utils/tags';

const formatDate = (value: Date | undefined) =>
  value ? new Intl.DateTimeFormat('en-US', { dateStyle: 'medium' }).format(value) : undefined;
const buildExcerpt = (body: string, limit = 220) => {
  const cleaned = body
    .replace(/`{1,3}[^`]*`{1,3}/g, '')
    .replace(/\[([^\]]+)\]\([^)]*\)/g, '$1')
    .replace(/[*_>#`~\-]/g, '')
    .replace(/\s+/g, ' ')
    .trim();

  if (cleaned.length <= limit) return cleaned;
  return `${cleaned.slice(0, limit - 1).trimEnd()}ƒ?İ`;
};

const postHref = (slug: string) => `${import.meta.env.BASE_URL}post/${slug}/`;
const posts = (await getCollection('posts'))
  .sort((a, b) => {
    const aDate = a.data.date ?? new Date(0);
    const bDate = b.data.date ?? new Date(0);
    return bDate.getTime() - aDate.getTime();
  })
  .map((post) => {
    const tagLinks = (post.data.tags ?? [])
      .map(buildTagLink)
      .filter((tag): tag is TagLink => Boolean(tag));

    return {
      ...post,
      preview: post.data.description ?? buildExcerpt(post.body ?? ''),
      tagLinks,
    };
  });
---
<BaseLayout title="Danny's Blog">
  <section>
    <div style="display: grid; gap: 1rem; margin-top: 1.5rem;">
      {posts.slice(0, 20).map((post) => (
        <article style="background: #111111; border: 1px solid #202020; border-radius: 12px; padding: 1.1rem 1.3rem;">
          <h2 style="margin: 0 0 0.35rem;">
            <a href={postHref(post.slug)} style="color: inherit;">
              {post.data.title ?? post.slug}
            </a>
          </h2>
          {formatDate(post.data.date) && (
            <div style="color: #bfbfbf; font-size: 0.95rem;">{formatDate(post.data.date)}</div>
          )}
          {post.preview && (
            <p style="margin: 0.75rem 0 0.65rem; color: #dedede;">{post.preview}</p>
          )}
          {post.tagLinks.length > 0 && (
            <div style="margin-top: 0.25rem; display: flex; flex-wrap: wrap; gap: 0.35rem;">
              {post.tagLinks.map((tag) => (
                <a
                  href={tag.href}
                  style="background: #1a1a1a; color: #f5f5f5; padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.85rem; border: 1px solid #2c2c2c;"
                >
                  {tag.name}
                </a>
              ))}
            </div>
          )}
          <div style="margin-top: 0.75rem;">
            <a href={postHref(post.slug)} style="font-weight: 600; color: #f2f2f2;">Read more</a>
          </div>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>
