<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damn field mappings!</title>

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/styles.css">

    <!-- Prism CSS (for code highlighting) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <!-- Prism JS (for code highlighting) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script> <!-- Add more languages as needed -->
</head>
<body class="bg-dark">
    <header class="bg-dark py-3">
        <div class="container bg-dark">
            <div class="d-flex justify-content-between align-items-center">
                <a href="/" class="home-link text-light"><h2>Danny McVey</h2></a>
                <nav>
                    <a href="/post/about-me.html" class="about-link btn btn-outline-light">About Me</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="container my-4">
        
<style>
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #49483e }
.codehilite .c { color: #75715e } /* Comment */
.codehilite .err { color: #960050; background-color: #1e0010 } /* Error */
.codehilite .esc { color: #f8f8f2 } /* Escape */
.codehilite .g { color: #f8f8f2 } /* Generic */
.codehilite .k { color: #66d9ef } /* Keyword */
.codehilite .l { color: #ae81ff } /* Literal */
.codehilite .n { color: #f8f8f2 } /* Name */
.codehilite .o { color: #f92672 } /* Operator */
.codehilite .x { color: #f8f8f2 } /* Other */
.codehilite .p { color: #f8f8f2 } /* Punctuation */
.codehilite .ch { color: #75715e } /* Comment.Hashbang */
.codehilite .cm { color: #75715e } /* Comment.Multiline */
.codehilite .cp { color: #75715e } /* Comment.Preproc */
.codehilite .cpf { color: #75715e } /* Comment.PreprocFile */
.codehilite .c1 { color: #75715e } /* Comment.Single */
.codehilite .cs { color: #75715e } /* Comment.Special */
.codehilite .gd { color: #f92672 } /* Generic.Deleted */
.codehilite .ge { color: #f8f8f2; font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #f8f8f2 } /* Generic.Error */
.codehilite .gh { color: #f8f8f2 } /* Generic.Heading */
.codehilite .gi { color: #a6e22e } /* Generic.Inserted */
.codehilite .go { color: #66d9ef } /* Generic.Output */
.codehilite .gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { color: #f8f8f2; font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #75715e } /* Generic.Subheading */
.codehilite .gt { color: #f8f8f2 } /* Generic.Traceback */
.codehilite .kc { color: #66d9ef } /* Keyword.Constant */
.codehilite .kd { color: #66d9ef } /* Keyword.Declaration */
.codehilite .kn { color: #f92672 } /* Keyword.Namespace */
.codehilite .kp { color: #66d9ef } /* Keyword.Pseudo */
.codehilite .kr { color: #66d9ef } /* Keyword.Reserved */
.codehilite .kt { color: #66d9ef } /* Keyword.Type */
.codehilite .ld { color: #e6db74 } /* Literal.Date */
.codehilite .m { color: #ae81ff } /* Literal.Number */
.codehilite .s { color: #e6db74 } /* Literal.String */
.codehilite .na { color: #a6e22e } /* Name.Attribute */
.codehilite .nb { color: #f8f8f2 } /* Name.Builtin */
.codehilite .nc { color: #a6e22e } /* Name.Class */
.codehilite .no { color: #66d9ef } /* Name.Constant */
.codehilite .nd { color: #a6e22e } /* Name.Decorator */
.codehilite .ni { color: #f8f8f2 } /* Name.Entity */
.codehilite .ne { color: #a6e22e } /* Name.Exception */
.codehilite .nf { color: #a6e22e } /* Name.Function */
.codehilite .nl { color: #f8f8f2 } /* Name.Label */
.codehilite .nn { color: #f8f8f2 } /* Name.Namespace */
.codehilite .nx { color: #a6e22e } /* Name.Other */
.codehilite .py { color: #f8f8f2 } /* Name.Property */
.codehilite .nt { color: #f92672 } /* Name.Tag */
.codehilite .nv { color: #f8f8f2 } /* Name.Variable */
.codehilite .ow { color: #f92672 } /* Operator.Word */
.codehilite .pm { color: #f8f8f2 } /* Punctuation.Marker */
.codehilite .w { color: #f8f8f2 } /* Text.Whitespace */
.codehilite .mb { color: #ae81ff } /* Literal.Number.Bin */
.codehilite .mf { color: #ae81ff } /* Literal.Number.Float */
.codehilite .mh { color: #ae81ff } /* Literal.Number.Hex */
.codehilite .mi { color: #ae81ff } /* Literal.Number.Integer */
.codehilite .mo { color: #ae81ff } /* Literal.Number.Oct */
.codehilite .sa { color: #e6db74 } /* Literal.String.Affix */
.codehilite .sb { color: #e6db74 } /* Literal.String.Backtick */
.codehilite .sc { color: #e6db74 } /* Literal.String.Char */
.codehilite .dl { color: #e6db74 } /* Literal.String.Delimiter */
.codehilite .sd { color: #e6db74 } /* Literal.String.Doc */
.codehilite .s2 { color: #e6db74 } /* Literal.String.Double */
.codehilite .se { color: #ae81ff } /* Literal.String.Escape */
.codehilite .sh { color: #e6db74 } /* Literal.String.Heredoc */
.codehilite .si { color: #e6db74 } /* Literal.String.Interpol */
.codehilite .sx { color: #e6db74 } /* Literal.String.Other */
.codehilite .sr { color: #e6db74 } /* Literal.String.Regex */
.codehilite .s1 { color: #e6db74 } /* Literal.String.Single */
.codehilite .ss { color: #e6db74 } /* Literal.String.Symbol */
.codehilite .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #a6e22e } /* Name.Function.Magic */
.codehilite .vc { color: #f8f8f2 } /* Name.Variable.Class */
.codehilite .vg { color: #f8f8f2 } /* Name.Variable.Global */
.codehilite .vi { color: #f8f8f2 } /* Name.Variable.Instance */
.codehilite .vm { color: #f8f8f2 } /* Name.Variable.Magic */
.codehilite .il { color: #ae81ff } /* Literal.Number.Integer.Long */
</style>
<div class="container bg-dark text-light">
    <article>
        <!-- Display the tags at the top -->
        
        <p class="post-tags text-light">
            
                <span class="post-tag">Python</span> 
            
                <span class="post-tag">GIS</span> 
            
                <span class="post-tag">Arcgis Pro</span>
            
        </p>
        
        <h1 class="text-light">Damn field mappings!</h1>
        <!-- Post content -->
        <p>Today, I created a batch spatial join tool and it happily ran on three different feature classes with slightly different schemas. without warning, it created null values in the output.</p>
<p>I have to remember this going forward, so i'm writing about it.</p>
<pre><code class="language-python ">
arcpy.ImportToolbox(r"C:\Users\mcveydb\AppData\Local\Temp\ArcGISProTemp33628\Tmp.atbx")
arcpy.Tmp.BatchSpatialJoin(
    target_features=r"AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans",
    join_features=r"\\sce\workgroup\CRE3\SMG\PROJECTS\Special_Projects\2020_Emergent_Dry_ Fuel_Work\2024\AOC_Fall_2024\AOC_2024_Fall.shp",
    out_feature_class=r"\\sce\workgroup\CRE3\SMG\PROJECTS\Special_Projects\2020_Emergent_Dry_ Fuel_Work\2024\AOC_Fall_2024\AOC_Fall_2024.gdb\%Name%_join",
    join_operation="JOIN_ONE_TO_ONE",
    join_type="KEEP_ALL",
    field_mapping=r'GESW_GESW_ID "GESW_GESW_ID" true true false 8 Double 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,GESW_GESW_ID,-1,-1;M3D_SCE_FID_GESW_COND "M3D_SCE_FID_GESW_COND" true true false 8 Double 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,M3D_SCE_FID_GESW_COND,-1,-1;CDS_CIRCUIT_NAME "CDS_CIRCUIT_NAME" true true false 150 Text 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,CDS_CIRCUIT_NAME,0,149;CDS_CIRCUIT_CONCAT "CDS_CIRCUIT_CONCAT" true true false 251 Text 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,CDS_CIRCUIT_CONCAT,0,250;M3D_SCE_ID_OH_UG_VAL "M3D_SCE_ID_OH_UG_VAL" true true false 255 Text 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,M3D_SCE_ID_OH_UG_VAL,0,254;M3D_ID_CONDUCTOR_TYPE_VAL "M3D_ID_CONDUCTOR_TYPE_VAL" true true false 255 Text 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,M3D_ID_CONDUCTOR_TYPE_VAL,0,254;M3D_ID_VOLTAGE_VAL "M3D_ID_VOLTAGE_VAL" true true false 255 Text 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,M3D_ID_VOLTAGE_VAL,0,254;M3D_SCE_ID_NO_OF_WIRES_VAL "M3D_SCE_ID_NO_OF_WIRES_VAL" true true false 255 Text 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,M3D_SCE_ID_NO_OF_WIRES_VAL,0,254;CDS_ANNOTATION_TEXT "CDS_ANNOTATION_TEXT" true true false 2000 Text 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,CDS_ANNOTATION_TEXT,0,1999;StaticObjID "StaticObjID" true true false 4 Long 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,StaticObjID,-1,-1;Shape_Length "Shape_Length" false true true 8 Double 0 0,First,#,AOC_2024_FALL_TRANS\AOC_2024_Fall_Trans,Shape_Length,-1,-1;OBJECTID "OBJECTID" true true false 10 Long 0 10,First,#,\\sce\workgroup\CRE3\SMG\PROJECTS\Special_Projects\2020_Emergent_Dry_ Fuel_Work\2024\AOC_Fall_2024\AOC_2024_Fall.shp,OBJECTID,-1,-1;Area_Name "Area_Name" true true false 100 Text 0 0,First,#,\\sce\workgroup\CRE3\SMG\PROJECTS\Special_Projects\2020_Emergent_Dry_ Fuel_Work\2024\AOC_Fall_2024\AOC_2024_Fall.shp,Area_Name,0,99;Tier "Tier" true true false 50 Text 0 0,First,#,\\sce\workgroup\CRE3\SMG\PROJECTS\Special_Projects\2020_Emergent_Dry_ Fuel_Work\2024\AOC_Fall_2024\AOC_2024_Fall.shp,Tier,0,49;FCZ "FCZ" true true false 50 Text 0 0,First,#,\\sce\workgroup\CRE3\SMG\PROJECTS\Special_Projects\2020_Emergent_Dry_ Fuel_Work\2024\AOC_Fall_2024\AOC_2024_Fall.shp,FCZ,0,49',
    match_option="INTERSECT",
    search_radius=None,
    distance_field_name="",
    match_fields=None
)
</code></pre>

<p>Look at that field_mapping, what a mess! It won't work at all for datasets with different names, let alone different fields. When running the tool manually over and over again, the field mapping parameter is set during parameter validation based on the value of the "target_features". </p>
<p>When running in batch mode or automated with python or model builder, there isn't an error produced. It might just run and create a bunch of null values in the output.</p>
<p>Does this happen with other methods? Like tabular joins, or similiar joins in pandas or geopandas? To be explored.</p>
<p>At first I tried to manually edit the field_mapping string itself, but that proved to be a fragile annoying process. I'm automating to avoid error prone tedium, not increase it!</p>
<p>Throught trial and error, i was able to make this work using the following function:</p>
<pre><code class="language-python">
def create_field_mappings(target, join, join_field, output_field_name=None, merge_rule=None, delimiter=', ', output_field_length=255):
    """
    Creates field mappings for spatial join, setting output field as text type and specified length.

    Parameters:
    target (str): The target feature class for the join.
    join (str): The join feature class.
    join_field (str): The field name in the join feature class to match properties.
    output_field_name (str, optional): The name for the output field. Default is the same as join_field.
    merge_rule (str, optional): The merge rule to apply ('Join', 'Sum', 'Mean', etc.). Default is None.
    delimiter (str, optional): The delimiter for 'Join' merge rule. Default is ', '.
    output_field_length (int, optional): The length for the output field. Default is 255.

    Returns:
    arcpy.FieldMappings: The field mappings for the spatial join.
    """
    # Create field mappings
    field_mappings = arcpy.FieldMappings()
    field_mappings.addTable(target)

    # Create and set up the field map
    field_map = arcpy.FieldMap()
    field_map.addInputField(join, join_field)

    # Set output field properties
    out_field = arcpy.Field()
    out_field.name = output_field_name if output_field_name else join_field
    out_field.aliasName = out_field.name
    if output_field_name == 'COUNTY':
        out_field.type = "String"  # Explicitly set as text type
        out_field.length = output_field_length  # Set length to 255

    if merge_rule:
        field_map.mergeRule = merge_rule
        if merge_rule.lower() == 'join':
            field_map.joinDelimiter = delimiter

    field_map.outputField = out_field

    # Add the field map to the field mappings
    field_mappings.addFieldMap(field_map)

    return field_mappings
</code></pre>

<p>The goal was to recreated, effectively, the field_mapping creation that happens when running the tool manually, but in a different context. It works!</p>
    </article>
</div>

<script src="/static/copy-code.js"></script>


    </main>

    <footer class="bg-dark py-3">
        <div class="container text-center text-light">
            <p>&copy; 2024 Danny McVey. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>